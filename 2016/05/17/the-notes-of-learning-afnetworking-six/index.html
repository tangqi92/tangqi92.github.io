<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AFNetworking 3.0 源码阅读笔记（六） · Qi Tang's Blog</title><meta name="description" content="AFNetworking 3.0 源码阅读笔记（六） - Qi Tang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imtangqi.com/atom.xml" title="Qi Tang's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/qiktang" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/tangqi92" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">AFNetworking 3.0 源码阅读笔记（六）</h1><div class="post-info">May 17, 2016</div><div class="post-content"><h2 id="前言">前言</h2><p><code>AFNetworkReachabilityManager</code> 是对 <code>SystemConfiguration</code> 模块的封装，苹果的文档中也有一个类似的项目 <a href="https://developer.apple.com/library/ios/samplecode/reachability/" target="_blank" rel="external">Reachability</a> 这里对网络状态的监控跟苹果官方的实现几乎是完全相同的。</p>
<p>同样在 GitHub 上有一个类似的项目叫做 <a href="https://github.com/tonymillion/Reachability" target="_blank" rel="external">Reachability</a> 不过这个项目<strong>由于命名的原因可能会在审核时被拒绝</strong>。</p>
<p>无论是 <code>AFNetworkReachabilityManager</code>，苹果官方的项目或者说 GitHub 上的 Reachability，它们的实现都是类似的，而在这里我们会以 <code>AFNetworking</code> 中的 <code>AFNetworkReachabilityManager</code> 为例来说明在 iOS 开发中，我们是怎样监控网络状态的。</p>
<a id="more"></a>
<hr>
<h2 id="AFNetworkReachabilityManager_的使用和实现">AFNetworkReachabilityManager 的使用和实现</h2><p><code>AFNetworkReachabilityManager</code> 的使用还是非常简单的，只需要三个步骤，就基本可以完成对网络状态的监控：</p>
<ol>
<li><a href="#init">初始化 <code>AFNetworkReachabilityManager</code></a></li>
<li><a href="#monitor">调用 <code>startMonitoring</code> 方法开始对网络状态进行监控</a></li>
<li><a href="#block">设置 <code>networkReachabilityStatusBlock</code> 在每次网络状态改变时, 调用这个 block</a></li>
</ol>
<h3 id="初始化_AFNetworkReachabilityManager"><a id="init"></a>初始化 AFNetworkReachabilityManager</h3><p>在初始化方法中，使用 <code>SCNetworkReachabilityCreateWithAddress</code> 或者 <code>SCNetworkReachabilityCreateWithName</code> 生成一个 <code>SCNetworkReachabilityRef</code> 的引用：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)managerForDomain:(<span class="built_in">NSString</span> *)domain &#123;</span><br><span class="line">    SCNetworkReachabilityRef reachability = SCNetworkReachabilityCreateWithName(k<span class="built_in">CFAllocatorDefault</span>, [domain UTF8String]);</span><br><span class="line"></span><br><span class="line">    AFNetworkReachabilityManager *manager = [[<span class="keyword">self</span> alloc] initWithReachability:reachability];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)managerForAddress:(<span class="keyword">const</span> <span class="keyword">void</span> *)address &#123;</span><br><span class="line">    SCNetworkReachabilityRef reachability = SCNetworkReachabilityCreateWithAddress(k<span class="built_in">CFAllocatorDefault</span>, (<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *)address);</span><br><span class="line">    AFNetworkReachabilityManager *manager = [[<span class="keyword">self</span> alloc] initWithReachability:reachability];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>这两个方法会通过一个<strong>域名</strong>或者一个 <code>sockaddr_in</code> 的指针生成一个 <code>SCNetworkReachabilityRef</code></li>
<li>调用 <code>- [AFNetworkReachabilityManager initWithReachability:]</code> 将生成的 <code>SCNetworkReachabilityRef</code> 引用传给 <code>networkReachability</code></li>
<li>设置一个默认的 <code>networkReachabilityStatus</code></li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithReachability:(SCNetworkReachabilityRef)reachability &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span><span class="variable">.networkReachability</span> = <span class="built_in">CFBridgingRelease</span>(reachability);</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.networkReachabilityStatus</span> = AFNetworkReachabilityStatusUnknown;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当调用 <code>CFBridgingRelease(reachability)</code> 后，会把 <code>reachability</code> 桥接成一个 NSObject 对象赋值给 <code>self.networkReachability</code>，然后释放原来的 CoreFoundation 对象。</p>
</blockquote>
<h3 id="监控网络状态"><a id="monitor"></a>监控网络状态</h3><p>在初始化 <code>AFNetworkReachabilityManager</code> 后，会调用 <code>startMonitoring</code> 方法开始监控网络状态：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startMonitoring &#123;</span><br><span class="line">    <span class="comment">// 1. 先调用 `- stopMonitoring` 方法，如果之前设置过对网络状态的监听，使用 `SCNetworkReachabilityUnscheduleFromRunLoop` 方法取消之前在 Main Runloop 中的监听</span></span><br><span class="line">    [<span class="keyword">self</span> stopMonitoring];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span><span class="variable">.networkReachability</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">// 2. 创建一个在每次网络状态改变时的回调</span></span><br><span class="line">    AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf = weakSelf;</span><br><span class="line"></span><br><span class="line">        strongSelf<span class="variable">.networkReachabilityStatus</span> = status;</span><br><span class="line">        <span class="keyword">if</span> (strongSelf<span class="variable">.networkReachabilityStatusBlock</span>) &#123;</span><br><span class="line">            strongSelf<span class="variable">.networkReachabilityStatusBlock</span>(status);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> networkReachability = <span class="keyword">self</span><span class="variable">.networkReachability</span>;</span><br><span class="line">    <span class="comment">// 3. 创建一个 `SCNetworkReachabilityContext`，其中的 `callback` 就是上一步中的创建的 block 对象</span></span><br><span class="line">    SCNetworkReachabilityContext context = &#123;<span class="number">0</span>, (__bridge <span class="keyword">void</span> *)callback, AFNetworkReachabilityRetainCallback, AFNetworkReachabilityReleaseCallback, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="comment">// 4. 当目标的网络状态改变时，会调用传入的回调</span></span><br><span class="line">    SCNetworkReachabilitySetCallback((__bridge SCNetworkReachabilityRef)networkReachability, AFNetworkReachabilityCallback, &amp;context);</span><br><span class="line">    <span class="comment">// 5. 在 Main Runloop 中对应的模式开始监控网络状态</span></span><br><span class="line">    SCNetworkReachabilityScheduleWithRunLoop((__bridge SCNetworkReachabilityRef)networkReachability, <span class="built_in">CFRunLoopGetMain</span>(), k<span class="built_in">CFRunLoopCommonModes</span>);</span><br><span class="line">    <span class="comment">// 6. 获取当前的网络状态，调用 callback</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>),^&#123;</span><br><span class="line">        SCNetworkReachabilityFlags flags;</span><br><span class="line">        <span class="keyword">if</span> (SCNetworkReachabilityGetFlags((__bridge SCNetworkReachabilityRef)networkReachability, &amp;flags)) &#123;</span><br><span class="line">            AFPostReachabilityStatusChange(flags, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1. 关于 <code>AFNetworkReachabilityStatus</code></strong>：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, AFNetworkReachabilityStatus) &#123;</span><br><span class="line">    AFNetworkReachabilityStatusUnknown          = -<span class="number">1</span>,</span><br><span class="line">    AFNetworkReachabilityStatusNotReachable     = <span class="number">0</span>,</span><br><span class="line">    AFNetworkReachabilityStatusReachableViaWWAN = <span class="number">1</span>,</span><br><span class="line">    AFNetworkReachabilityStatusReachableViaWiFi = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>2. 关于 <code>SCNetworkReachabilityContext</code></strong>：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个 SCNetworkReachabilityContext 结构体时，需要调用 SCDynamicStore 的创建函数，而此创建函数会根据 version 来创建出不同的结构体，SCNetworkReachabilityContext 对应的 version 是 0</span></span><br><span class="line">    <span class="built_in">CFIndex</span>		version;</span><br><span class="line">    <span class="comment">// 下面两个block（release 和 retain）的参数就是 info，此处表示的是网络状态处理的回调函数</span></span><br><span class="line">    <span class="keyword">void</span> *		__nullable info;</span><br><span class="line">    <span class="comment">// 该 retain block 用于对 info 进行 retain，下面那个 AFNetworkReachabilityRetainCallback 核心就是调用了 Block_copy（用于 retain 一个 block 函数，即在堆空间新建或直接引用一个 block 拷贝）</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span>	* __nonnull (* __nullable retain)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">    <span class="comment">// 该 release block 用于对 info 进行 release，下面那个 AFNetworkReachabilityReleaseCallback 核心就是调用了 Block_release（用于 release 一个 block 函数，即将 block 从堆空间移除或移除相应引用）</span></span><br><span class="line">    <span class="keyword">void</span>		(* __nullable release)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">    <span class="comment">// 提供 info 的 description，此处调用为 NULL</span></span><br><span class="line">    <span class="built_in">CFStringRef</span>	__nonnull (* __nullable copyDescription)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">&#125; SCNetworkReachabilityContext;</span><br></pre></td></tr></table></figure>
<p>在下一节中会介绍上面所提到的一些 C 函数以及各种回调。</p>
<h3 id="设置_networkReachabilityStatusBlock_以及回调"><a id="block"></a>设置 networkReachabilityStatusBlock 以及回调</h3><p>在 Main Runloop 中对网络状态进行监控之后，在每次网络状态改变，就会调用 <code>AFNetworkReachabilityCallback</code> 函数：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> AFNetworkReachabilityCallback(SCNetworkReachabilityRef __unused target, SCNetworkReachabilityFlags flags, <span class="keyword">void</span> *info) &#123;</span><br><span class="line">    AFPostReachabilityStatusChange(flags, (__bridge AFNetworkReachabilityStatusBlock)info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会从 <code>info</code> 中取出之前存在 <code>context</code> 中的 <code>AFNetworkReachabilityStatusBlock</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</span><br><span class="line">AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line">    __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf = weakSelf;</span><br><span class="line"></span><br><span class="line">    strongSelf<span class="variable">.networkReachabilityStatus</span> = status;</span><br><span class="line">    <span class="keyword">if</span> (strongSelf<span class="variable">.networkReachabilityStatusBlock</span>) &#123;</span><br><span class="line">        strongSelf<span class="variable">.networkReachabilityStatusBlock</span>(status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>取出这个 block 之后，传入 <code>AFPostReachabilityStatusChange</code> 函数：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> AFPostReachabilityStatusChange(SCNetworkReachabilityFlags flags, AFNetworkReachabilityStatusBlock block) &#123;</span><br><span class="line">    AFNetworkReachabilityStatus status = AFNetworkReachabilityStatusForFlags(flags);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (block) &#123;</span><br><span class="line">            block(status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSNotificationCenter</span> *notificationCenter = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123; AFNetworkingReachabilityNotificationStatusItem: @(status) &#125;;</span><br><span class="line">        [notificationCenter postNotificationName:AFNetworkingReachabilityDidChangeNotification object:<span class="literal">nil</span> userInfo:userInfo];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>调用 <code>AFNetworkReachabilityStatusForFlags</code> 获取当前的网络可达性状态</li>
<li><strong>在主线程中异步执行</strong>上面传入的 <code>callback</code> block（设置 <code>self</code> 的网络状态，调用 <code>networkReachabilityStatusBlock</code>）</li>
<li>发送 <code>AFNetworkingReachabilityDidChangeNotification</code> 通知.</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> AFNetworkReachabilityStatus AFNetworkReachabilityStatusForFlags(SCNetworkReachabilityFlags flags) &#123;</span><br><span class="line">    <span class="comment">// 该网络地址可达</span></span><br><span class="line">    <span class="built_in">BOOL</span> isReachable = ((flags &amp; kSCNetworkReachabilityFlagsReachable) != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 该网络地址虽然可达，但是需要先建立一个 connection</span></span><br><span class="line">    <span class="built_in">BOOL</span> needsConnection = ((flags &amp; kSCNetworkReachabilityFlagsConnectionRequired) != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 该网络虽然也需要先建立一个 connection，但是它是可以自动去 connect 的</span></span><br><span class="line">    <span class="built_in">BOOL</span> canConnectionAutomatically = (((flags &amp; kSCNetworkReachabilityFlagsConnectionOnDemand ) != <span class="number">0</span>) || ((flags &amp; kSCNetworkReachabilityFlagsConnectionOnTraffic) != <span class="number">0</span>));</span><br><span class="line">    <span class="comment">// 不需要用户交互，就可以 connect 上（用户交互一般指的是提供网络的账户和密码）</span></span><br><span class="line">    <span class="built_in">BOOL</span> canConnectWithoutUserInteraction = (canConnectionAutomatically &amp;&amp; (flags &amp; kSCNetworkReachabilityFlagsInterventionRequired) == <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 如果 isReachable==YES，那么就需要判断是不是得先建立一个 connection，如果需要，那就认为不可达，或者虽然需要先建立一个 connection，但是不需要用户交互，那么认为也是可达的</span></span><br><span class="line">    <span class="built_in">BOOL</span> isNetworkReachable = (isReachable &amp;&amp; (!needsConnection || canConnectWithoutUserInteraction));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  AFNetworkReachabilityStatus 就四种状态 Unknown、NotReachable、ReachableViaWWAN、ReachableViaWiFi，这四种状态字面意思很好理解，这里就不赘述了</span></span><br><span class="line">    AFNetworkReachabilityStatus status = AFNetworkReachabilityStatusUnknown;</span><br><span class="line">    <span class="keyword">if</span> (isNetworkReachable == <span class="literal">NO</span>) &#123;</span><br><span class="line">        status = AFNetworkReachabilityStatusNotReachable;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#if	TARGET_OS_IPHONE</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; kSCNetworkReachabilityFlagsIsWWAN) != <span class="number">0</span>) &#123;</span><br><span class="line">        status = AFNetworkReachabilityStatusReachableViaWWAN;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        status = AFNetworkReachabilityStatusReachableViaWiFi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 <code>flags</code> 是一个 <code>SCNetworkReachabilityFlags</code>，它的不同位代表了不同的网络可达性状态，通过 <code>flags</code> 的位操作，获取当前的状态信息 <code>AFNetworkReachabilityStatus</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_OPTIONS</span>(uint32_t, SCNetworkReachabilityFlags) &#123;</span><br><span class="line">    kSCNetworkReachabilityFlagsTransientConnection = <span class="number">1</span>&lt;&lt;<span class="number">0</span>,</span><br><span class="line">    kSCNetworkReachabilityFlagsReachable = <span class="number">1</span>&lt;&lt;<span class="number">1</span>,</span><br><span class="line">    kSCNetworkReachabilityFlagsConnectionRequired = <span class="number">1</span>&lt;&lt;<span class="number">2</span>,</span><br><span class="line">    kSCNetworkReachabilityFlagsConnectionOnTraffic = <span class="number">1</span>&lt;&lt;<span class="number">3</span>,</span><br><span class="line">    kSCNetworkReachabilityFlagsInterventionRequired = <span class="number">1</span>&lt;&lt;<span class="number">4</span>,</span><br><span class="line">    kSCNetworkReachabilityFlagsConnectionOnDemand = <span class="number">1</span>&lt;&lt;<span class="number">5</span>, <span class="comment">// __OSX_AVAILABLE_STARTING(__MAC_10_6,__IPHONE_3_0)</span></span><br><span class="line">    kSCNetworkReachabilityFlagsIsLocalAddress = <span class="number">1</span>&lt;&lt;<span class="number">16</span>,</span><br><span class="line">    kSCNetworkReachabilityFlagsIsDirect = <span class="number">1</span>&lt;&lt;<span class="number">17</span>,</span><br><span class="line"><span class="preprocessor">#if  TARGET_OS_IPHONE</span></span><br><span class="line">    kSCNetworkReachabilityFlagsIsWWAN = <span class="number">1</span>&lt;&lt;<span class="number">18</span>,</span><br><span class="line"><span class="preprocessor">#endif  // TARGET_OS_IPHONE</span></span><br><span class="line"></span><br><span class="line">    kSCNetworkReachabilityFlagsConnectionAutomatic = kSCNetworkReachabilityFlagsConnectionOnTraffic</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里就是在 <code>SystemConfiguration</code> 中定义的全部的网络状态的标志位。</p>
<hr>
<h2 id="与_AFNetworking_协作">与 AFNetworking 协作</h2><p>其实 <code>AFNetworkReachabilityManager</code> 与 <code>AFNetworking</code> 整个框架并没有太多的耦合。正相反，它在整个框架中作为一个<strong>即插即用</strong>的类使用，每一个 <code>AFURLSessionManager</code> 都会持有一个 <code>AFNetworkReachabilityManager</code> 的实例。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span><span class="variable">.reachabilityManager</span> = [AFNetworkReachabilityManager sharedManager];</span><br></pre></td></tr></table></figure>
<p>这是整个框架中除了 <code>AFNetworkReachabilityManager.h/m</code> 文件，<strong>唯一一个</strong>引用到这个类的地方。</p>
<hr>
<h2 id="总结">总结</h2><ul>
<li><code>AFNetworkReachabilityManager</code> 实际上只是对底层 <code>SystemConfiguration</code> 库中的 C 函数封装的类（类似于 GCD），它为我们隐藏了 C 语言的实现，提供了统一且简洁的 Objective-C 语言接口</li>
<li>它是 <code>AFNetworking</code> 中一个即插即用的模块</li>
</ul>
<hr>
<h2 id="参考">参考</h2><ul>
<li><a href="https://github.com/Draveness/iOS-Source-Code-Analyze/blob/master/AFNetworking/AFNetworkReachabilityManager%20%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%EF%BC%88%E5%9B%9B%EF%BC%89.md" target="_blank" rel="external">AFNetworkReachabilityManager 监控网络状态（四）</a></li>
<li><a href="http://www.cnblogs.com/polobymulberry/p/5174298.html" target="_blank" rel="external">【原】AFNetworking源码阅读（六）</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2016/05/20/the-notes-of-learning-afnetworking-seven/" class="prev">上一篇</a><a href="/2016/05/15/the-notes-of-learning-afnetworking-five/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'tangqi92githubio';
var disqus_identifier = '2016/05/17/the-notes-of-learning-afnetworking-six/';
var disqus_title = 'AFNetworking 3.0 源码阅读笔记（六）';
var disqus_url = 'http://imtangqi.com/2016/05/17/the-notes-of-learning-afnetworking-six/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//tangqi92githubio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="http://imtangqi.com">Qi Tang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-61827851-1",'auto');ga('send','pageview');</script></body></html>