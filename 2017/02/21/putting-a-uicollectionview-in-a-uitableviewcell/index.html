<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> UITableViewCell 中嵌套 UICollectionView 的实现 · Tang's Blog</title><meta name="description" content="UITableViewCell 中嵌套 UICollectionView 的实现 - Tang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imtangqi.com/atom.xml" title="Tang's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">UITableViewCell 中嵌套 UICollectionView 的实现</h1><div class="post-info">Feb 21, 2017</div><div class="post-content"><h2 id="前言">前言</h2><p>自从去年来到花瓣实习以后，因为时间与精力（其实就是懒）的原因，这半年多没有写过一篇技术相关的文章。不过，随着项目的逐渐进展，我想，有必要对一些知识点进行总结与回顾了。与此同时，如果能帮助到大家就最好不过了：）</p>
<a id="more"></a>
<p>本文中的参考 Demo：<a href="https://github.com/tangqi92/QTTableCollectionView" target="_blank" rel="external">https://github.com/tangqi92/QTTableCollectionView</a>，请结合 Demo 阅读本文。</p>
<hr>
<h2 id="需求">需求</h2><p><img src="http://7xikfc.com1.z0.glb.clouddn.com/putting-a-uicollectionview-in-a-uitableviewcell-01.png" alt=""></p>
<p>这是 <strong>花瓣 4.0</strong> 中「个人主页」里的「关注」页面，我想，你一定会非常熟悉这样的界面布局：竖向与横向滚动列表的结合，我们熟悉的 <strong>App Store</strong>，其首页便是代表之一。</p>
<hr>
<h2 id="分析">分析</h2><p>本文的实现方式是：UITableView + UICollectionView 的结合（其实后来发现，仅仅使用 UICollectionView 就可以实现，不管啦~）。</p>
<p>于是，我们将页面简化，可以得到下图：</p>
<p><img src="http://7xikfc.com1.z0.glb.clouddn.com/putting-a-uicollectionview-in-a-uitableviewcell-03.png" alt=""></p>
<p>现在，我们来分析下 Layout 结构：最外层当然是 UITableView，然后其中每个 UITableViewCell 中包含着一个 UICollectionView，而其中的 UICollectionViewCell 有 3 种不同的样式（既红、绿、蓝三种样式）。于是，我们又得到了下图：</p>
<p><img src="http://7xikfc.com1.z0.glb.clouddn.com/putting-a-uicollectionview-in-a-uitableviewcell-04.png" alt=""></p>
<p>没错，我们将 UITableView 与 UICollectionView 的 Delegate 与 DataSource 都由 TableViewController 处理，是希望 UITableViewCell 中不要出现不必要的代码。</p>
<hr>
<h2 id="实现">实现</h2><p>下面，我们以 <a href="https://github.com/tangqi92/QTTableCollectionView" target="_blank" rel="external">https://github.com/tangqi92/QTTableCollectionView</a> 为例进行讲解。首先，来看下项目的目录结构：</p>
<p><img src="http://7xikfc.com1.z0.glb.clouddn.com/putting-a-uicollectionview-in-a-uitableviewcell-06.png" alt=""></p>
<h3 id="Model">Model</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QTExploreModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> 请根据自身需求，定义相关 Model 类与其属性。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>QTExploreModel</code> \ <code>QTBoardModel</code> \ <code>QTUserModel</code> 3 个 Model 类，在这里仅是象征性作用，请根据实际项目需求定义。</p>
<h3 id="View">View</h3><h4 id="自定义_UICollectionViewCell">自定义 UICollectionViewCell</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QTExploresCollectionViewCell</span> : <span class="title">UICollectionViewCell</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) QTExploreModel *exploreModel;</span><br><span class="line"><span class="comment">/// 该方仅法用于测试。</span></span><br><span class="line">- (<span class="keyword">void</span>)setupModel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QTExploresCollectionViewCell</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> 请根据自身需求，自定义 CollectionViewCell。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIView</span> *coverView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QTExploresCollectionViewCell</span></span></span><br><span class="line"></span><br><span class="line">- (instancetype)initWithFrame:(<span class="built_in">CGRect</span>)frame &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:frame];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initViews];</span><br><span class="line">        <span class="keyword">self</span><span class="variable">.layer</span><span class="variable">.cornerRadius</span> = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">self</span><span class="variable">.layer</span><span class="variable">.masksToBounds</span> = <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">self</span><span class="variable">.backgroundColor</span> = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initViews &#123;</span><br><span class="line">    _coverView = [<span class="built_in">UIView</span> new];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.contentView</span> addSubview:_coverView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">    [_coverView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make<span class="variable">.edges</span><span class="variable">.equalTo</span>(<span class="keyword">self</span><span class="variable">.contentView</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setExploreModel:(QTExploreModel *)exploreModel &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 数据填充</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupModel &#123;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.coverView</span><span class="variable">.backgroundColor</span> = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>QTExploresCollectionViewCell</code> \ <code>QTBoardsCollectionViewCell</code> \ <code>QTUsersCollectionViewCell</code> 3 个自定义 UICollectionViewCell，也请根据实际项目需求自行定义。</p>
<h4 id="自定义_UICollectionView">自定义 UICollectionView</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 3 种类型的 Cell。</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, CollectionViewCellType) &#123;</span><br><span class="line">    CellTypeExplores = <span class="number">0</span>,</span><br><span class="line">    CellTypeBoards,</span><br><span class="line">    CellTypeUsers</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QTCollectionView</span> : <span class="title">UICollectionView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// indexPath 用于查询相应的 Model，并填充至 Cell。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSIndexPath</span> *indexPath;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) CollectionViewCellType collectionViewCellType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>indexPath</code> 用于记录 UICollectionView 所处的位置，而 <code>CollectionViewCellType</code> 用于区分不同类型的 UICollectionViewCell（当然，你可以直接使用 indexPath.section（0、1、2） 用以区别，只是我个人比较倾向使用枚举而已）。</p>
<h4 id="自定义_UITableViewCell">自定义 UITableViewCell</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> ExploreCollectionViewCellID = <span class="string">@"ExploreCollectionViewCellID"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> BoardCollectionViewCellID = <span class="string">@"BoardCollectionViewCellID"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> UserCollectionViewCellID = <span class="string">@"UserCollectionViewCellID"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QTTableViewCell</span> : <span class="title">UITableViewCell</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// UITableViewCell 中嵌套 CollectionView。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) QTCollectionView *collectionView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 设置 CollectionView 的 DataSource 与 Delegate。</span></span><br><span class="line">- (<span class="keyword">void</span>)setCollectionViewDataSourceDelegate:(<span class="keyword">id</span>&lt;<span class="built_in">UICollectionViewDataSource</span>, <span class="built_in">UICollectionViewDelegate</span>, <span class="built_in">UICollectionViewDelegateFlowLayout</span>&gt;)dataSourceDelegate indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>本文前面已经提过，该界面实现的关键便在于 <code>UITableViewCell</code> 中嵌套 <code>UICollectionView</code>，并将 <code>UICollectionView</code> 的 Delegate 与 DataSource 交由 <code>UITableViewController</code> 处理。在这里，我们使用 <code>- (void)setCollectionViewDataSourceDelegate:indexPath:</code> 处理。下面，我们再来看下 <code>QTTableViewCell</code> 的具体实现：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QTTableViewCell</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithStyle:(<span class="built_in">UITableViewCellStyle</span>)style reuseIdentifier:(<span class="built_in">NSString</span> *)reuseIdentifier &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">self</span> = [<span class="keyword">super</span> initWithStyle:style reuseIdentifier:reuseIdentifier])) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 UICollectionViewFlowLayout 进行布局。</span></span><br><span class="line">    <span class="comment">// 注册 UICollectionViewCell。</span></span><br><span class="line">    <span class="comment">// 其他初始化操作。</span></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)layoutSubviews &#123;</span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.collectionView</span> mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make<span class="variable">.edges</span><span class="variable">.equalTo</span>(<span class="keyword">self</span><span class="variable">.contentView</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCollectionViewDataSourceDelegate:(<span class="keyword">id</span>&lt;<span class="built_in">UICollectionViewDataSource</span>, <span class="built_in">UICollectionViewDelegate</span>&gt;)dataSourceDelegate indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.collectionView</span><span class="variable">.dataSource</span> = dataSourceDelegate;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.collectionView</span><span class="variable">.delegate</span> = dataSourceDelegate;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.collectionView</span><span class="variable">.indexPath</span> = indexPath;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.collectionView</span> setContentOffset:<span class="keyword">self</span><span class="variable">.collectionView</span><span class="variable">.contentOffset</span> animated:<span class="literal">NO</span>];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.collectionView</span> reloadData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="Controller">Controller</h3><h4 id="UITableViewController_的实现">UITableViewController 的实现</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)tableView:(<span class="built_in">UITableView</span> *)tableView willDisplayCell:(QTTableViewCell *)cell forRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="comment">// 为 TableViewCell 中的 CollectionView 设置不同的 collectionViewCellType 用以区别，此处一共 3 种样式。</span></span><br><span class="line">    <span class="keyword">if</span> (indexPath<span class="variable">.section</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        cell<span class="variable">.collectionView</span><span class="variable">.collectionViewCellType</span> = CellTypeExplores;</span><br><span class="line">        <span class="built_in">NSInteger</span> index = cell<span class="variable">.collectionView</span><span class="variable">.indexPath</span><span class="variable">.row</span>;</span><br><span class="line">        <span class="built_in">CGFloat</span> horizontalOffset = [<span class="keyword">self</span><span class="variable">.contentOffsetDictionaryOfExplores</span>[[@(index) stringValue]] floatValue];</span><br><span class="line">        <span class="comment">// 设置 CollectionView 的 ContentOffset，在'- (void)scrollViewDidScroll:(UIScrollView *)scrollView;' 中存储的。</span></span><br><span class="line">        [cell<span class="variable">.collectionView</span> setContentOffset:<span class="built_in">CGPointMake</span>(horizontalOffset, <span class="number">0</span>)];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (indexPath<span class="variable">.section</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        cell<span class="variable">.collectionView</span><span class="variable">.collectionViewCellType</span> = CellTypeBoards;</span><br><span class="line">        <span class="built_in">NSInteger</span> index = cell<span class="variable">.collectionView</span><span class="variable">.indexPath</span><span class="variable">.row</span>;</span><br><span class="line">        <span class="built_in">CGFloat</span> horizontalOffset = [<span class="keyword">self</span><span class="variable">.contentOffsetDictionaryOfBoards</span>[[@(index) stringValue]] floatValue];</span><br><span class="line">        <span class="comment">// 设置 CollectionView 的 ContentOffset。</span></span><br><span class="line">        [cell<span class="variable">.collectionView</span> setContentOffset:<span class="built_in">CGPointMake</span>(horizontalOffset, <span class="number">0</span>)];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (indexPath<span class="variable">.section</span> == <span class="number">2</span>) &#123;</span><br><span class="line">        cell<span class="variable">.collectionView</span><span class="variable">.collectionViewCellType</span> = CellTypeUsers;</span><br><span class="line">        <span class="built_in">NSInteger</span> index = cell<span class="variable">.collectionView</span><span class="variable">.indexPath</span><span class="variable">.row</span>;</span><br><span class="line">        <span class="built_in">CGFloat</span> horizontalOffset = [<span class="keyword">self</span><span class="variable">.contentOffsetDictionaryOfUsers</span>[[@(index) stringValue]] floatValue];</span><br><span class="line">        <span class="comment">// 设置 CollectionView 的 ContentOffset。</span></span><br><span class="line">        [cell<span class="variable">.collectionView</span> setContentOffset:<span class="built_in">CGPointMake</span>(horizontalOffset, <span class="number">0</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// !!!: 设置 CollectionView 的 DataSource 与 Delegate 及所处的 indexPath。</span></span><br><span class="line">    [cell setCollectionViewDataSourceDelegate:<span class="keyword">self</span> indexPath:indexPath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记住，在 UITableViewCell 中的 CollectionView 是在 Cell 之后初始化的，也就是在初始化这个 Cell 的之后要立即设置这个 Cell 中 CollectionView 的数据源跟代理。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UICollectionViewCell</span> *)collectionView:(QTCollectionView *)collectionView cellForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="built_in">UICollectionViewCell</span> *cell = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (collectionView<span class="variable">.collectionViewCellType</span> == CellTypeExplores) &#123;</span><br><span class="line">        cell = [collectionView dequeueReusableCellWithReuseIdentifier:ExploreCollectionViewCellID forIndexPath:indexPath];</span><br><span class="line">        <span class="keyword">if</span> ([cell isKindOfClass:[QTExploresCollectionViewCell class]]) &#123;</span><br><span class="line">            QTExploresCollectionViewCell *cellExplore = (QTExploresCollectionViewCell *) cell;</span><br><span class="line">            [cellExplore setupModel];</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> 获取到相应的 Model 后进行赋值操作</span></span><br><span class="line">            <span class="comment">//            if (self.dataSourceExplores.count &gt; 0) &#123;</span></span><br><span class="line">            <span class="comment">//                cellExplore.exploreModel = self.dataSourceExplores[indexPath.row];</span></span><br><span class="line">            <span class="comment">//            &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (collectionView<span class="variable">.collectionViewCellType</span> == CellTypeBoards) &#123;</span><br><span class="line">        cell = [collectionView dequeueReusableCellWithReuseIdentifier:BoardCollectionViewCellID forIndexPath:indexPath];</span><br><span class="line">        <span class="keyword">if</span> ([cell isKindOfClass:[QTBoardsCollectionViewCell class]]) &#123;</span><br><span class="line">            QTBoardsCollectionViewCell *cellBoard = (QTBoardsCollectionViewCell *) cell;</span><br><span class="line">            [cellBoard setupModel];</span><br><span class="line">            <span class="comment">//            if (self.dataSourceBoards.count &gt; 0) &#123;</span></span><br><span class="line">            <span class="comment">//                cellBoard.boardModel = self.dataSourceBoards[indexPath.row];</span></span><br><span class="line">            <span class="comment">//            &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (collectionView<span class="variable">.collectionViewCellType</span> == CellTypeUsers) &#123;</span><br><span class="line">        cell = [collectionView dequeueReusableCellWithReuseIdentifier:UserCollectionViewCellID forIndexPath:indexPath];</span><br><span class="line">        <span class="keyword">if</span> ([cell isKindOfClass:[QTUsersCollectionViewCell class]]) &#123;</span><br><span class="line">            QTUsersCollectionViewCell *cellUser = (QTUsersCollectionViewCell *) cell;</span><br><span class="line">            [cellUser setupModel];</span><br><span class="line">            <span class="comment">//            if (self.dataSourceUsers.count &gt; 0) &#123;</span></span><br><span class="line">            <span class="comment">//                cellUser.userModel = self.dataSourceUsers[indexPath.row];</span></span><br><span class="line">            <span class="comment">//            &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)scrollViewDidScroll:(<span class="built_in">UIScrollView</span> *)scrollView &#123;</span><br><span class="line">    <span class="keyword">if</span> (![scrollView isKindOfClass:[<span class="built_in">UICollectionView</span> class]])</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGFloat</span> horizontalOffset = scrollView<span class="variable">.contentOffset</span><span class="variable">.x</span>;</span><br><span class="line">    QTCollectionView *collectionView = (QTCollectionView *) scrollView;</span><br><span class="line">    <span class="built_in">NSInteger</span> index = collectionView<span class="variable">.indexPath</span><span class="variable">.row</span>;</span><br><span class="line">    <span class="comment">// 根据 collectionViewCellType 存储对应的偏移量</span></span><br><span class="line">    <span class="keyword">if</span> (collectionView<span class="variable">.collectionViewCellType</span> == CellTypeExplores) &#123;</span><br><span class="line">        <span class="keyword">self</span><span class="variable">.contentOffsetDictionaryOfExplores</span>[[@(index) stringValue]] = @(horizontalOffset);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (collectionView<span class="variable">.collectionViewCellType</span> == CellTypeBoards) &#123;</span><br><span class="line">        <span class="keyword">self</span><span class="variable">.contentOffsetDictionaryOfBoards</span>[[@(index) stringValue]] = @(horizontalOffset);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (collectionView<span class="variable">.collectionViewCellType</span> == CellTypeUsers) &#123;</span><br><span class="line">        <span class="keyword">self</span><span class="variable">.contentOffsetDictionaryOfUsers</span>[[@(index) stringValue]] = @(horizontalOffset);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 Cell 的重用机制，我们需要通过辅助手段，记住每个 UICollectionView 中滑动的偏移量，这里通过：<code>- (void)scrollViewDidScroll:(UIScrollView *)scrollView</code> 实现。</p>
<p>整个代码比较简单，辅助上注释，相信并不难理解。大功告成，我们来看下最后的实现效果吧：</p>
<p><img src="http://7xikfc.com1.z0.glb.clouddn.com/putting-a-uicollectionview-in-a-uitableviewcell-07.png" alt=""></p>
<p><img src="http://7xikfc.com1.z0.glb.clouddn.com/putting-a-uicollectionview-in-a-uitableviewcell-09.png" alt=""></p>
<hr>
<h2 id="感谢">感谢</h2><p>本文绝大部分思想来自 <a href="https://ashfurrow.com/blog/putting-a-uicollectionview-in-a-uitableviewcell/" target="_blank" rel="external">Putting a UICollectionView in a UITableViewCell</a>，再次表示感谢！</p>
<p>如果你是个 Swifter，这里提供一篇基于 Swift 的文章 <a href="https://www.thorntech.com/2015/08/want-your-swift-app-to-scroll-in-two-directions-like-netflix-heres-how/" target="_blank" rel="external">https://www.thorntech.com/2015/08/want-your-swift-app-to-scroll-in-two-directions-like-netflix-heres-how/</a> 以供参考。</p>
<hr>
<h2 id="参考">参考</h2><ol>
<li><a href="https://ashfurrow.com/blog/putting-a-uicollectionview-in-a-uitableviewcell/" target="_blank" rel="external">Putting a UICollectionView in a UITableViewCell</a></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/28/uitableview-cell-separatorinset/" class="prev">上一篇</a><a href="/2016/06/12/garbage-collection-in-java/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'tangqi92githubio';
var disqus_identifier = '2017/02/21/putting-a-uicollectionview-in-a-uitableviewcell/';
var disqus_title = 'UITableViewCell 中嵌套 UICollectionView 的实现';
var disqus_url = 'http://imtangqi.com/2017/02/21/putting-a-uicollectionview-in-a-uitableviewcell/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//tangqi92githubio.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="http://imtangqi.com">Tang</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-61827851-1",'auto');ga('send','pageview');</script></body></html>